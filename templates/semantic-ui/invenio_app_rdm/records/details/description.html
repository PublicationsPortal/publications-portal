{#
Copyright (C) 2020-2025 CERN.
Copyright (C) 2020 Northwestern University.
Copyright (C) 2021 New York University.

Invenio RDM Records is free software; you can redistribute it and/or modify
it under the terms of the MIT License; see LICENSE file for more details.
#}

{%- from "invenio_app_rdm/records/macros/detail.html" import show_add_descriptions %}

{% set description = metadata.get('description') %}

{% set simple_summary_abstract = record.get('custom_fields', {}).get('summarization:summarization',
{}).get('simple', "")
%}
{% set advanced_summary_abstract = record.get('custom_fields',
{}).get("summarization:summarization", {}).get("advanced", "") %}

{% if description %}
<section id="description" class="rel-mt-2 rich-input-content"
  aria-label="{{ _('Record description') }}">
  <h2 id="description-heading" class="sr-only">{{ _('Description') }}</h2>
  {% set has_simple_summary = simple_summary_abstract and simple_summary_abstract.strip() %}
  {% set has_advanced_summary = advanced_summary_abstract and advanced_summary_abstract.strip() %}

  {% if has_simple_summary or has_advanced_summary %}
  <div id="button-container"
    style="display: flex; align-items: center; gap: 0.3rem; margin-bottom: 1rem; flex-wrap: wrap;">
    <button id="summary-toggle-btn" class="ui button blue basic"
      style="font-size: 0.9rem; padding: 0.8em 1.2em; transition: background 0.3s;">
      <i id="summary-btn-icon" class="graduation cap icon" style="font-size: 1rem;"></i>
      <span id="summary-btn-text">AI Summary</span>
    </button>
  </div>
  {% endif %}

  <!-- Dynamic content type heading -->
  <div id="content-type-heading"
    style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
    <h3
      style="margin: 0; font-size: 1.2em; color: #333; font-weight: 600; display: flex; align-items: center; line-height: 1.2;">
      <i id="content-type-icon" class="file alternate outline icon"
        style="margin-right: 0.5rem; font-size: 1em; vertical-align: middle;"></i>
      <span id="content-type-title"
        style="display: inline-flex; align-items: center;">Abstract</span>
      <div id="disclaimer-popup" style="display: none; margin-left: 0.5rem;">
        <i class="help circle icon"
          style="color: #6a82fb; cursor: pointer; font-size: 1.1rem; vertical-align: middle; align-items: center; justify-content: center; min-width: 1.1rem; min-height: 1.1rem;"
          title="Disclaimer: The AI Summary is not a scientific research tool but a communication aid powered by a Large Language Model (LLM). It provides simplified summaries of scientific abstracts to enhance accessibility for non-specialists. While efforts are made to ensure accuracy, the outputs should not replace professional scientific interpretation or advice."
          onclick="showDisclaimer()"></i>
      </div>
    </h3>
  </div>
  <div id="description-content"
    style="word-wrap: break-word; transition: opacity 0.5s, transform 0.5s;">
    {{ description | safe }}
  </div>
  <div id="summary-container" style="display: none;">
    <div style="
      background: #f4f8fb;
      border-radius: 10px;
      padding: 1.2em 1em;
      margin-top: 0.5em;
      box-shadow: 0 2px 12px rgba(106,130,251,0.07);
      border-left: 4px solid #6a82fb;
      font-style: italic;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      height: 400px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    ">
      <div id="summary-header" style="
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.8rem;
        color: #333;
        font-weight: 600;
        flex-shrink: 0;
        line-height: 1.2;
      ">
        <i id="summary-icon" class="graduation cap icon"
          style="color: #6a82fb; font-size: 1em; vertical-align: middle;"></i>
        <span id="summary-title" style="display: inline-flex; align-items: center;">AI
          Summary</span>
        <i class="help circle icon"
          style="color: #6a82fb; cursor: pointer; font-size: 1.1rem; vertical-align: middle; align-items: center; justify-content: center; min-width: 1.1rem; min-height: 1.1rem;"
          title="Disclaimer: The AI Summary is not a scientific research tool but a communication aid powered by a Large Language Model (LLM). It provides simplified summaries of scientific abstracts to enhance accessibility for non-specialists. While efforts are made to ensure accuracy, the outputs should not replace professional scientific interpretation or advice."
          onclick="showDisclaimer()"></i>
      </div>
      <div id="summary-content" style="
        word-wrap: break-word;
        line-height: 1.5;
        color: #555;
        overflow: auto;
        flex: 1;
        padding-right: 0.5rem;
      ">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>
</section>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const mode = urlParams.get('mode');

  // Get elements
  const summaryToggleBtn = document.getElementById('summary-toggle-btn');
  const summaryBtnIcon = document.getElementById('summary-btn-icon');
  const summaryBtnText = document.getElementById('summary-btn-text');
  const descContent = document.getElementById('description-content');
  const summaryContainer = document.getElementById('summary-container');
  const summaryContent = document.getElementById('summary-content');
  const summaryIcon = document.getElementById('summary-icon');
  const summaryTitle = document.getElementById('summary-title');
  const contentTypeHeading = document.getElementById('content-type-heading');

  // Summary content from server
  const simpleSummary = `{{ simple_summary_abstract | safe }}`;
  const advancedSummary = `{{ advanced_summary_abstract | safe }}`;

  // Check if summaries exist (from server-side)
  const hasSimpleSummary = {{ 'true' if has_simple_summary else 'false' }};
  const hasAdvancedSummary = {{ 'true' if has_advanced_summary else 'false' }};

  // Current state tracking: 'original', 'advanced', 'simple'
  let currentState = 'original';

  // Function to update button and content based on current state
  function updateDisplay() {
    if (currentState === 'original') {
      // Show original content, hide summary
      descContent.style.display = 'block';
      summaryContainer.style.display = 'none';
      contentTypeHeading.style.display = 'flex'; // Show "Abstract" title

      // Set button to show next available summary
      if (hasAdvancedSummary) {
        summaryBtnIcon.className = 'graduation cap icon';
        summaryBtnText.textContent = 'AI Summary';
      } else if (hasSimpleSummary) {
        summaryBtnIcon.className = 'lightbulb outline icon';
        summaryBtnText.textContent = 'Simple AI Summary';
      }
    } else if (currentState === 'advanced') {
      // Show advanced summary
      descContent.style.display = 'none';
      summaryContainer.style.display = 'block';
      contentTypeHeading.style.display = 'none'; // Hide "Abstract" title
      summaryIcon.className = 'graduation cap icon';
      summaryTitle.textContent = 'AI Summary';
      summaryContent.innerHTML = advancedSummary;

      // Reset scroll position to top
      summaryContent.scrollTop = 0;

      // Set button for next action
      if (hasSimpleSummary) {
        summaryBtnIcon.className = 'lightbulb outline icon';
        summaryBtnText.textContent = 'Simple AI Summary';
      } else {
        summaryBtnIcon.className = 'times icon';
        summaryBtnText.textContent = 'Close';
      }
    } else if (currentState === 'simple') {
      // Show simple summary
      descContent.style.display = 'none';
      summaryContainer.style.display = 'block';
      contentTypeHeading.style.display = 'none'; // Hide "Abstract" title
      summaryIcon.className = 'lightbulb outline icon';
      summaryTitle.textContent = 'Simple AI Summary';
      summaryContent.innerHTML = simpleSummary;

      // Reset scroll position to top
      summaryContent.scrollTop = 0;

      // Set button to close
      summaryBtnIcon.className = 'times icon';
      summaryBtnText.textContent = 'Close';
    }
  }

  // Cycling logic
  function cycleSummary() {
    if (currentState === 'original') {
      // From original, go to advanced if available, otherwise simple
      if (hasAdvancedSummary) {
        currentState = 'advanced';
      } else if (hasSimpleSummary) {
        currentState = 'simple';
      }
    } else if (currentState === 'advanced') {
      // From advanced, go to simple if available, otherwise close
      if (hasSimpleSummary) {
        currentState = 'simple';
      } else {
        currentState = 'original';
      }
    } else if (currentState === 'simple') {
      // From simple, always close
      currentState = 'original';
    }

    updateDisplay();
  }

  // Disclaimer function
  function showDisclaimer() {
    alert('Disclaimer: The AI Summary is not a scientific research tool but a communication aid powered by a Large Language Model (LLM). It provides simplified summaries of scientific abstracts to enhance accessibility for non-specialists. While efforts are made to ensure accuracy, the outputs should not replace professional scientific interpretation or advice.');
  }

  // Event listener for button
  if (summaryToggleBtn) {
    summaryToggleBtn.addEventListener('click', cycleSummary);
  }

  // Initialize display
  updateDisplay();

  // Handle beginner mode (optional - can be removed if not needed)
  if (mode === 'beginner' && hasSimpleSummary) {
    // In beginner mode, show simple summary by default
    currentState = 'simple';
    updateDisplay();
  }
</script>
{% endif %}